name: Release

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to publish"
        required: true
        type: choice
        options:
          - all
          - shared
          - ai-audit
          - sdk
          - router
      dry-run:
        description: "Dry run (no actual publish)"
        required: true
        type: boolean
        default: true

env:
  BUN_VERSION: "1.3.9"

jobs:
  # ──────────────────────────────────────────────
  # Quality gate — full check before any publish
  # ──────────────────────────────────────────────
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v5
        with:
          path: |
            node_modules
            ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - run: bun install --frozen-lockfile
      - run: bun run lint
      - run: bun run typecheck
      - run: bun run build
      - run: bun run test

      - name: Verify dist artifacts
        run: |
          for pkg in shared ai-audit sdk router; do
            test -d "packages/$pkg/dist" || { echo "::error::Missing dist for $pkg"; exit 1; }
          done

  # ──────────────────────────────────────────────
  # Publish — respects dependency order
  # shared → ai-audit + sdk (parallel) → router
  # ──────────────────────────────────────────────
  publish-shared:
    name: Publish @prompt-os/shared
    if: inputs.package == 'all' || inputs.package == 'shared'
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - run: bun install --frozen-lockfile
      - run: bun run build

      - name: Publish
        working-directory: packages/shared
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "::notice::DRY RUN — @prompt-os/shared"
            npm publish --provenance --dry-run
          else
            npm publish --provenance --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-ai-audit:
    name: Publish @prompt-os/ai-audit
    if: inputs.package == 'all' || inputs.package == 'ai-audit'
    needs: [validate, publish-shared]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - run: bun install --frozen-lockfile
      - run: bun run build

      - name: Resolve workspace protocol
        working-directory: packages/ai-audit
        run: |
          SHARED_VERSION=$(node -p "require('../shared/package.json').version")
          sed -i 's/"workspace:\*"/"'"$SHARED_VERSION"'"/g' package.json

      - name: Publish
        working-directory: packages/ai-audit
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "::notice::DRY RUN — @prompt-os/ai-audit"
            npm publish --provenance --dry-run
          else
            npm publish --provenance --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-sdk:
    name: Publish @prompt-os/sdk
    if: inputs.package == 'all' || inputs.package == 'sdk'
    needs: [validate, publish-shared]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - run: bun install --frozen-lockfile
      - run: bun run build

      - name: Resolve workspace protocol
        working-directory: packages/sdk
        run: |
          SHARED_VERSION=$(node -p "require('../shared/package.json').version")
          sed -i 's/"workspace:\*"/"'"$SHARED_VERSION"'"/g' package.json

      - name: Publish
        working-directory: packages/sdk
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "::notice::DRY RUN — @prompt-os/sdk"
            npm publish --provenance --dry-run
          else
            npm publish --provenance --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-router:
    name: Publish @prompt-os/router
    if: inputs.package == 'all' || inputs.package == 'router'
    needs: [validate, publish-shared, publish-sdk]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - run: bun install --frozen-lockfile
      - run: bun run build

      - name: Resolve workspace protocol
        working-directory: packages/router
        run: |
          SHARED_VERSION=$(node -p "require('../shared/package.json').version")
          SDK_VERSION=$(node -p "require('../sdk/package.json').version")
          sed -i 's/"@prompt-os\/shared": "workspace:\*"/"@prompt-os\/shared": "'"$SHARED_VERSION"'"/g' package.json
          sed -i 's/"@prompt-os\/sdk": "workspace:\*"/"@prompt-os\/sdk": "'"$SDK_VERSION"'"/g' package.json

      - name: Publish
        working-directory: packages/router
        run: |
          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "::notice::DRY RUN — @prompt-os/router"
            npm publish --provenance --dry-run
          else
            npm publish --provenance --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
